---
import '../styles/global.css';
// Layout.astro: site metadata for SEO and sidebar post navigation
import { getCollection } from 'astro:content';
import { filterPostsForBuild } from '../lib/build-filter';
const { site, url } = Astro;
const { noSidebar = false, pageTitle, metaDescription, noIndex = false, disableCanonical = false } = Astro.props as {
  noSidebar?: boolean;
  pageTitle?: string;
  metaDescription?: string;
  noIndex?: boolean;
  disableCanonical?: boolean;
};
const canonicalUrl = new URL(url.pathname, site).toString();
const siteTitle = 'Subaru is Running';
const siteDescription = 'Training logs, race reports, and running notes by Subaru.';
const headTitle = pageTitle ?? siteTitle;
const headDescription = metaDescription ?? siteDescription;

// Fetch published posts for sidebar and calendar
const posts = filterPostsForBuild(await getCollection('blog', ({ data }) => data.status === 'publish'));
posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Limit sidebar to latest N posts; category filter can load more via JSON
const SIDEBAR_LIMIT = 50;
const sidebarPosts = posts.slice(0, SIDEBAR_LIMIT);
const sidebarItems = sidebarPosts.map((p) => ({
  slug: p.slug,
  title: p.data.title,
  date: p.data.date.toISOString(),
  category: p.data.category,
}));
const sidebarItemsJson = JSON.stringify(sidebarItems).replace(/</g, '\\u003c');

// Derive unique categories for sidebar filter
const categories = Array.from(new Set(posts.map((p) => p.data.category))).sort();
categories.unshift('All');

// Prepare calendar data: date -> compact { s: first slug, c: count } mapping
const postsByDate = posts.reduce((acc, p) => {
  const key = p.slug.slice(0, 10); // YYYY-MM-DD from filename
  if (!acc[key]) acc[key] = { s: p.slug, c: 1 };
  else acc[key].c += 1;
  return acc;
}, {} as Record<string, { s: string; c: number }>);
// Note: we no longer inline the calendar map to reduce page size.

// Years available for selection
const years = Array.from(new Set(posts.map((p) => p.data.date.getFullYear()))).sort((a, b) => a - b);
const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.getMonth();

// Determine initial calendar view: prefer selected post's month, else latest post, else current
let initialYear = currentYear;
let initialMonth = currentMonth; // 0-11

const latestSlugDate = posts[0]?.slug.slice(0, 10);
if (latestSlugDate) {
  const [ly, lm] = latestSlugDate.split('-');
  initialYear = parseInt(ly, 10);
  initialMonth = parseInt(lm, 10) - 1;
}

const pathMatch = url.pathname.match(/^\/(\d{4})-(\d{2})-/);
if (pathMatch) {
  initialYear = parseInt(pathMatch[1], 10);
  initialMonth = parseInt(pathMatch[2], 10) - 1;
}

// Server-render initial month grid for better UX (no-JS fallback)
function buildInitialMonth(year: number, month: number) {
  const first = new Date(year, month, 1);
  const startDay = first.getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const rows: { day: number; slug?: string; count?: number }[][] = [];
  let day = 1;
  for (let r = 0; r < 6; r++) {
    const row: { day: number; slug?: string; count?: number }[] = [];
    for (let c = 0; c < 7; c++) {
      if (r === 0 && c < startDay) {
        row.push({ day: 0 });
      } else if (day > daysInMonth) {
        row.push({ day: 0 });
      } else {
        const key = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const entry = postsByDate[key];
        if (entry) {
          row.push({ day, slug: entry.s, count: entry.c });
        } else {
          row.push({ day });
        }
        day++;
      }
    }
    rows.push(row);
  }
  return rows;
}
const initialMonthRows = buildInitialMonth(initialYear, initialMonth);
---
<!doctype html>
<html lang="en" class="scroll-smooth">
	<head>
		<meta charset="UTF-8" />
			<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{headTitle}</title>
		{!disableCanonical && <link rel="canonical" href={canonicalUrl} />}
		{noIndex && <meta name="robots" content="noindex,follow" />}
		<meta property="og:url" content={canonicalUrl} />
    <meta name="description" content={headDescription} />
    <meta property="og:title" content={headTitle} />
    <meta property="og:site_name" content={siteTitle} />
    <meta property="og:type" content="website" />
    <meta property="og:description" content={headDescription} />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={headTitle} />
    <meta name="twitter:description" content={headDescription} />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QMP63NE6Q1"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);} 
      gtag('js', new Date());
      // Configure GA with privacy-friendly defaults
      gtag('config', 'G-QMP63NE6Q1', { anonymize_ip: true });
    </script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7941378059940304" crossorigin="anonymous"></script>
    <!-- Mobile menu toggler (delegated) -->
    <script is:inline>
      (function(){
        function onClick(e){
          var t = e.target;
          var btn = (t && (t.id === 'menuBtn')) ? t : (t && t.closest ? t.closest('#menuBtn') : null);
          if (!btn) return;
          var menu = document.getElementById('mobileMenu');
          if (menu) { menu.classList.toggle('hidden'); }
        }
        document.addEventListener('click', onClick);
      })();
    </script>
    
	</head>
	<body class="min-h-screen bg-gradient-to-b from-white to-gray-50 dark:from-gray-950 dark:to-gray-900">
		<header class="bg-white/90 dark:bg-gray-950/80 backdrop-blur border-b border-gray-200 dark:border-gray-800 sticky top-0 z-30">
			<div class="container-page flex items-center justify-between py-4">
				<div class="flex items-center gap-4 min-w-0">
					<a href="/" class="flex items-center gap-3 no-underline shrink-0">
						<img src="/logo-mark.svg" alt="" aria-hidden="true" class="h-9 w-9 rounded-lg" width="36" height="36" />
						<span class="text-lg md:text-xl font-bold">{siteTitle}</span>
					</a>
                <nav class="hidden md:flex items-center gap-2 ml-2">
                    <a href="/blog/" class="text-sm rounded-md px-3 py-1.5 ring-1 ring-inset ring-gray-300 dark:ring-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">ブログ</a>
                    <a href="/running-pace/" class="text-sm rounded-md px-3 py-1.5 ring-1 ring-inset ring-gray-300 dark:ring-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">ペース計算</a>
                    <a href="/pdf-compress/" class="text-sm rounded-md px-3 py-1.5 ring-1 ring-inset ring-gray-300 dark:ring-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">PDF圧縮</a>
                    <a href="/about/" class="text-sm rounded-md px-3 py-1.5 ring-1 ring-inset ring-gray-300 dark:ring-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">このサイトについて</a>
                    <a href="/contact/" class="text-sm rounded-md px-3 py-1.5 ring-1 ring-inset ring-gray-300 dark:ring-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">お問い合わせ</a>
                </nav>
				</div>
				<button id="menuBtn" class="md:hidden text-sm rounded-md px-3 py-1.5 ring-1 ring-inset ring-gray-300 dark:ring-gray-700">メニュー</button>
			</div>
			<!-- Mobile menu -->
            <div id="mobileMenu" class="md:hidden container-page py-2 hidden">
                <nav class="flex flex-col gap-2">
                    <a href="/blog/" class="rounded-md px-3 py-2 ring-1 ring-inset ring-gray-200 dark:ring-gray-800">ブログ</a>
                    <a href="/running-pace/" class="rounded-md px-3 py-2 ring-1 ring-inset ring-gray-200 dark:ring-gray-800">ペース計算</a>
                    <a href="/pdf-compress/" class="rounded-md px-3 py-2 ring-1 ring-inset ring-gray-200 dark:ring-gray-800">PDF圧縮</a>
                    <a href="/about/" class="rounded-md px-3 py-2 ring-1 ring-inset ring-gray-200 dark:ring-gray-800">このサイトについて</a>
                    <a href="/contact/" class="rounded-md px-3 py-2 ring-1 ring-inset ring-gray-200 dark:ring-gray-800">お問い合わせ</a>
                </nav>
            </div>
		</header>
		{ noSidebar ? (
			<div class="container-page py-8">
				<main class="min-w-0">
					<slot />
				</main>
			</div>
		) : (
			<div class="container-page grid grid-cols-1 lg:grid-cols-[20rem_1fr] gap-8 py-8">
			<!-- Calendar first on mobile, left column on desktop -->
			<div class="order-1 lg:order-1 lg:sticky lg:top-20 self-start">
					<div class="card px-4 py-4">
						<h2 class="text-lg font-semibold mb-2">カレンダー</h2>
						<div class="flex gap-2 mb-3">
							<label for="calendarYear" class="sr-only">年</label>
							<select id="calendarYear" class="border rounded px-2 py-1 flex-1 bg-white dark:bg-gray-900">
								{years.map((y) => (
									<option value={y} selected={y === initialYear}>{y}</option>
								))}
							</select>
							<label for="calendarMonth" class="sr-only">月</label>
							<select id="calendarMonth" class="border rounded px-2 py-1 flex-1 bg-white dark:bg-gray-900">
								{[...Array(12)].map((_, i) => (
									<option value={i} selected={i === initialMonth}>{new Date(2000, i, 1).toLocaleString('ja-JP', { month: 'short' })}</option>
								))}
							</select>
						</div>
						<table class="w-full text-sm text-center select-none">
							<thead>
								<tr class="text-gray-500 dark:text-gray-400">
									{['Su','Mo','Tu','We','Th','Fr','Sa'].map((d) => (<th class="py-1 font-medium">{d}</th>))}
								</tr>
							</thead>
							<tbody id="calendarBody">
								{initialMonthRows.map((week) => (
									<tr>
										{week.map((cell) => (
											<td class="py-1">
												{cell.day === 0 ? (
													<span class="inline-block w-8 h-8"></span>
												) : cell.slug ? (
													<a href={`/${cell.slug}/`} class="inline-block w-8 h-8 leading-8 rounded hover:bg-blue-50 text-blue-600 underline">
														{cell.day}
														{cell.count && cell.count > 1 ? (
															<span class="ml-1 text-[10px] text-gray-600">{cell.count}</span>
														) : null}
													</a>
												) : (
													<span class="inline-block w-8 h-8 leading-8 rounded text-gray-700">{cell.day}</span>
												)}
											</td>
										))}
									</tr>
								))}
							</tbody>
						</table>
						<p class="mt-2 text-xs text-gray-500 dark:text-gray-400">記事のある日はクリックできます。</p>
					</div>
			</div>
	   <script type="application/json" id="sidebarItemsData" set:html={sidebarItemsJson}></script>
	   <!-- Removed inlined calendar seed to slim page size -->
	   <script>
  (function initUI() {
    // Sidebar/calendar, category filter, etc.
    function initSidebar() {
      const init = () => {
        // Calendar data: prefer cached full map, then fetch async; avoid large inline seed
            let POSTS_BY_DATE = {};
            const loadedMonths = new Set();
            const CURRENT_MONTH_TTL_MS = 5 * 60 * 1000;
            const PAST_MONTH_TTL_MS = 30 * 24 * 60 * 60 * 1000;

      // Fallback: scrape sidebar only if no JSON present
          if (!Object.keys(POSTS_BY_DATE).length) {
        document.querySelectorAll('#blog-nav a[href^="/"]').forEach((a) => {
          const href = a.getAttribute('href') || '';
          const m = href.match(/^\/(\d{4}-\d{2}-\d{2})(?:-|\/)/);
          if (m) {
            const key = m[1];
            const slug = href.replace(/^\/+|\/+$/g, '');
            if (POSTS_BY_DATE[key]) {
              POSTS_BY_DATE[key].c = (POSTS_BY_DATE[key].c || 0) + 1;
            } else {
              POSTS_BY_DATE[key] = { s: slug, c: 1 };
            }
          }
        });
      }

      const yearSel = document.getElementById('calendarYear');
      const monthSel = document.getElementById('calendarMonth');
      const tbody = document.getElementById('calendarBody');

      if (yearSel && monthSel && tbody) {
        const pad = (n) => (n < 10 ? '0' + n : '' + n);
        const dateKey = (y, m, d) => `${y}-${pad(m + 1)}-${pad(d)}`;

        function mergeInitialMonthFromDOM() {
          const y = parseInt(yearSel.value, 10);
          const m = parseInt(monthSel.value, 10);
          if (!Number.isFinite(y) || !Number.isFinite(m)) return;
          tbody.querySelectorAll('a[href^="/"]').forEach((a) => {
            const dayText = a.childNodes?.[0]?.textContent || a.textContent || '';
            const day = parseInt(dayText.trim(), 10);
            if (!Number.isFinite(day)) return;
            const key = dateKey(y, m, day);
            const slug = (a.getAttribute('href') || '').replace(/^\/+|\/+$/g, '');
            if (!slug) return;
            if (POSTS_BY_DATE[key]) {
              POSTS_BY_DATE[key].c = Math.max(POSTS_BY_DATE[key].c || 1, 1);
              POSTS_BY_DATE[key].s = POSTS_BY_DATE[key].s || slug;
            } else {
              POSTS_BY_DATE[key] = { s: slug, c: 1 };
            }
          });
        }

        function renderCalendar() {
          const y = parseInt(yearSel.value, 10);
          const m = parseInt(monthSel.value, 10);
          if (!loadedMonths.has(monthKey(y, m))) return;
          const first = new Date(y, m, 1);
          const startDay = first.getDay();
          const daysInMonth = new Date(y, m + 1, 0).getDate();

          tbody.innerHTML = '';
          let day = 1;
          for (let r = 0; r < 6; r++) {
            const tr = document.createElement('tr');
            for (let c = 0; c < 7; c++) {
              const td = document.createElement('td');
              td.className = 'py-1';
              if (r === 0 && c < startDay) {
                td.innerHTML = '\u00A0';
              } else if (day > daysInMonth) {
                td.innerHTML = '\u00A0';
              } else {
                const key = dateKey(y, m, day);
                const entry = POSTS_BY_DATE[key];
                if (entry) {
                  const a = document.createElement('a');
                  a.href = `/${entry.s}/`;
                  a.textContent = String(day);
                  a.className = 'inline-block w-8 h-8 leading-8 rounded hover:bg-blue-50 text-blue-600 underline';
                  if (entry.c > 1) {
                    const badge = document.createElement('span');
                    badge.textContent = String(entry.c);
                    badge.className = 'ml-1 text-[10px] text-gray-600';
                    a.appendChild(badge);
                  }
                  td.appendChild(a);
                } else {
                  const span = document.createElement('span');
                  span.textContent = String(day);
                  span.className = 'inline-block w-8 h-8 leading-8 rounded text-gray-700';
                  td.appendChild(span);
                }
                day++;
              }
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
        }

        function monthKey(y, m) {
          return `${y}-${pad(m + 1)}`;
        }

        function mergeMonthData(data) {
          for (const key in data) {
            POSTS_BY_DATE[key] = data[key];
          }
        }

        function loadCachedMonth(y, m) {
          const key = monthKey(y, m);
          try {
            const raw = localStorage.getItem(`CAL_MAP_MONTH_${key}`);
            const tsRaw = localStorage.getItem(`CAL_MAP_MONTH_TS_${key}`);
            const ts = tsRaw ? Number(tsRaw) : 0;
            if (!raw) return null;
            const data = JSON.parse(raw);
            return { data, ts };
          } catch (_) {
            return null;
          }
        }

        function monthTTL(y, m) {
          const now = new Date();
          const isCurrent = now.getFullYear() === y && now.getMonth() === m;
          return isCurrent ? CURRENT_MONTH_TTL_MS : PAST_MONTH_TTL_MS;
        }

        async function ensureMonthData(y, m) {
          const key = monthKey(y, m);
          const cached = loadCachedMonth(y, m);
          const ttl = monthTTL(y, m);
          const now = Date.now();

          if (cached && cached.data && now - cached.ts <= ttl) {
            mergeMonthData(cached.data);
            loadedMonths.add(key);
            return true;
          }

          try {
            const res = await fetch(`/cal-map/${y}/${pad(m + 1)}.json`);
            if (!res.ok) {
              loadedMonths.add(key);
              return false;
            }
            const data = await res.json();
            mergeMonthData(data);
            loadedMonths.add(key);
            try {
              localStorage.setItem(`CAL_MAP_MONTH_${key}`, JSON.stringify(data));
              localStorage.setItem(`CAL_MAP_MONTH_TS_${key}`, String(now));
            } catch (_) {}
            return true;
          } catch (_) {
            loadedMonths.add(key);
            return false;
          }
        }

        async function loadAndRender() {
          const y = parseInt(yearSel.value, 10);
          const m = parseInt(monthSel.value, 10);
          if (!Number.isFinite(y) || !Number.isFinite(m)) return;
          await ensureMonthData(y, m);
          renderCalendar();
        }

        yearSel.addEventListener('change', loadAndRender);
        monthSel.addEventListener('change', loadAndRender);
        mergeInitialMonthFromDOM();
        loadAndRender();
      }

      const sel = document.getElementById('sidebarCategory');
      const list = document.querySelector('#blog-nav ul');
      const currentSlug = window.location.pathname.replace(/^\/|\/$/g, '');
      const sidebarData = document.getElementById('sidebarItemsData');
      let INITIAL_ITEMS = [];
      if (sidebarData) {
        try {
          INITIAL_ITEMS = JSON.parse(sidebarData.textContent || '[]');
        } catch (_) {
          INITIAL_ITEMS = [];
        }
      }
      let categoryMapPromise = null;

      function renderList(items) {
        if (!list) return;
        list.innerHTML = '';
        if (!items.length) {
          const li = document.createElement('li');
          li.className = 'px-3 py-2 text-sm text-gray-500';
          li.textContent = 'No posts.';
          list.appendChild(li);
          return;
        }
        for (const item of items) {
          const li = document.createElement('li');
          li.dataset.category = item.category;
          const a = document.createElement('a');
          a.href = `/${item.slug}/`;
          const isActive = item.slug === currentSlug;
          a.className = `block rounded-md px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition ${isActive ? 'bg-gray-100 dark:bg-gray-800 font-semibold' : ''}`;
          const title = document.createElement('span');
          title.className = 'line-clamp-1';
          title.textContent = item.title;
          const date = document.createElement('small');
          date.className = 'text-xs text-gray-500';
          date.textContent = new Date(item.date).toDateString();
          a.appendChild(title);
          a.appendChild(date);
          li.appendChild(a);
          list.appendChild(li);
        }
      }

      async function loadCategoryMap() {
        if (!categoryMapPromise) {
          categoryMapPromise = fetch('/category-map.json')
            .then((r) => (r.ok ? r.json() : {}))
            .catch(() => ({}));
        }
        return categoryMapPromise;
      }

      if (sel && list) {
        sel.addEventListener('change', async () => {
          const selected = sel.value;
          if (selected === 'All') {
            renderList(INITIAL_ITEMS);
            return;
          }
          const map = await loadCategoryMap();
          const items = Array.isArray(map[selected]) ? map[selected] : [];
          renderList(items);
        });
      }
      };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    }

    // Wire on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => { initSidebar(); });
    } else {
      initSidebar();
    }
  })();
</script>
			<main class="order-2 lg:order-2 min-w-0">
				<slot />
			</main>

			<!-- Sidebar remainder below content on mobile, left column on desktop -->
			<div class="order-3 lg:order-3 self-start space-y-4">
					<!-- Sidebar category filter -->
					<div class="card px-4 py-3">
						<label for="sidebarCategory" class="block mb-1 font-medium">カテゴリ</label>
						<select id="sidebarCategory" class="w-full border rounded px-2 py-1 bg-white dark:bg-gray-900">
							{categories.map((cat) => (
								<option value={cat}>{cat}</option>
							))}
						</select>
					</div>

					<nav id="blog-nav" class="card px-2 py-2">
						<ul>
								{sidebarPosts.map((item) => (
								<li data-category={item.data.category}>
									<a href={`/${item.slug}/`} class={`block rounded-md px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-800 transition ${item.slug === url.pathname.slice(1, -1) ? 'bg-gray-100 dark:bg-gray-800 font-semibold' : ''}`}>
										<span class="line-clamp-1">{item.data.title}</span>
										<small class="text-xs text-gray-500">{item.data.date.toDateString()}</small>
									</a>
								</li>
							))}
						</ul>
						<div class="px-2 py-2 border-t border-gray-100 dark:border-gray-800 text-sm">
							<a class="underline" href="/archive/">記事一覧を見る →</a>
						</div>
						</nav>
			</div>
        </div>
        )}
        <footer class="mt-10 border-t border-gray-200 dark:border-gray-800">
            <div class="container-page py-8 text-sm text-gray-500 dark:text-gray-400 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div>© {new Date().getFullYear()} Subaru Misc Blog</div>
                <nav class="flex items-center gap-4">
                    <a href="/privacy/" class="underline">プライバシーポリシー</a>
                    <a href="/about/" class="underline">このサイトについて</a>
                    <a href="/contact/" class="underline">お問い合わせ</a>
                </nav>
            </div>
        </footer>
	</body>
	</html>
