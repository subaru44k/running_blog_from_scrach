repo:
  components:
    astro_blog:
      paths:
        - astro-blog/src/pages
        - astro-blog/src/layouts/Layout.astro
        - astro-blog/src/content
      integrations:
        - tailwind
        - react
      build:
        buildspec: astro-blog/buildspec.yml
        output_dir: astro-blog/dist
      deploy_targets:
        - TODO: CloudFront + S3 (exact resource names)
      url_routes:
        canonical:
          - /
          - /blog/
          - /draw/
          - /draw/play/
          - /draw/result/
          - /running-pace/
          - /pdf-compress/
          - /contact/
          - /privacy/
          - /about/
          - /404.html
        generated:
          - /sitemap.xml
          - /category-map.json
    admin_app:
      purpose: "管理UIとスクリプトによるブログ編集/生成"
      entry: admin-app/server.js
      scripts:
        - admin-app/scripts/import-fitbit-workouts.js
        - admin-app/scripts/generate-monthly-summary.js
    lambdas:
      fitbit_callback:
        path: lambdas/fitbit-callback
        handler: index.mjs
        infra: cloudformation.yaml
      sign_upload_v3:
        path: lambdas/sign-upload-v3
        handler: index.mjs
    pdf_compress_service:
      path: pdf-compress-service
      docker:
        dockerfile: pdf-compress-service/Dockerfile
      lambda_entry: pdf-compress-service/lambda.js
    draw_backend:
      path: backend/draw
      handlers:
        - backend/draw/src/handlers/uploadUrl.ts
        - backend/draw/src/handlers/submit.ts
        - backend/draw/src/handlers/secondaryStatus.ts
        - backend/draw/src/handlers/secondaryWorker.ts
        - backend/draw/src/handlers/leaderboard.ts

site:
  routing:
    canonical_routes:
      - /
      - /blog/
      - /draw/
      - /draw/play/
      - /draw/result/
      - /running-pace/
      - /pdf-compress/
      - /contact/
      - /privacy/
      - /about/
    section_anchors:
      /running-pace/:
        - "#calculator"
        - "#table"
    not_found_policy:
      status: 404
      body: /404.html
      seo:
        canonical: disabled
        robots: noindex,follow

features:
  pdf_compress:
    steps:
      - sign-upload: create presigned POST (url + fields)
      - upload: POST PDF to S3 uploads/
      - compress: call /compress level=1/2/3 (parallel)
      - outputs: store outputs/*.pdf
      - previews: store previews/*.png (best-effort)
    upload_max_mb: 50
    url_ttl_seconds:
      download_preview: 600
      upload: 600
    aws_resources: TODO
    security_notes:
      - temp files are stored for a limited time (S3 lifecycle assumed)
      - keepSource=true avoids race deletion during parallel processing
  fitbit:
    oauth:
      callback_lambda: fitbit-callback
      token_storage: S3 token.json
    draft_generation:
      script: admin-app/scripts/import-fitbit-workouts.js
    storage: TODO
  draw_backend:
    routes:
      - /draw/
      - /draw/play/
      - /draw/result/
    behavior:
      - API Gateway + Lambda backend for upload/submit/secondary/leaderboard
      - frontend uses PUBLIC_DRAW_API_BASE to call /api/draw/*
      - Lambda handlers are bundled as CommonJS (.cjs) for Node 20 runtime compatibility
      - image upload via S3 signed PUT
      - CloudFront signed URL for image viewing (900s)
      - secondary review is async via SQS
      - primary review displays only score + short comment + up to 2 badges
      - secondary review may update the comment to a richer short summary
      - secondary review is fetched via polling API for ranked entries only
      - secondary status API requires promptId and submissionId
      - share card generated in browser
      - submit API accepts optional promptText from the client
      - primary scoring uses Bedrock Claude 3 Haiku (fallback to stub)
      - secondary review uses Bedrock Claude Haiku 4.5 (fallback behavior keeps pending then failed)
      - Bedrock token usage is stored per submission (primary/secondary input, output, total, modelId, latency)
      - draw routes are included in sitemap and linked from global nav

assumptions:
  - TODO: CloudFront Distribution ID and error response settings are managed outside docs
  - TODO: S3 lifecycle policies for uploads/outputs/previews
  - TODO: API Gateway endpoints for pdf-compress and sign-upload lambdas
  - TODO: Exact production domains for admin-app (if any)
  - TODO: OAuth app scopes and admin-app env var templates
