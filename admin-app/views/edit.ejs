<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= file ? 'Edit' : 'New' %> Post</title>
</head>
<body>
  <h1><%= file ? 'Edit' : 'New' %> Post</h1>
  <form action="<%= file ? '/edit/' + encodeURIComponent(file) : '/new' %>" method="POST">
    <fieldset>
      <legend>Metadata</legend>
      <div>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" value="<%= data.title || '' %>" required />
      </div>
      <div>
        <label for="date">Date (YYYY-MM-DD):</label>
        <input type="date" id="date" name="date" value="<%= data.date ? (new Date(data.date).toISOString().slice(0,10)) : '' %>" required />
      </div>
      <div>
        <label for="author">Author:</label>
        <input type="text" id="author" name="author" value="<%= data.author || '' %>" />
      </div>
      <div>
        <label for="category">Category:</label>
        <select id="category" name="category">
          <% (categories || []).forEach(function(cat){ %>
            <option value="<%= cat %>" <%= (data.category === cat) ? 'selected' : '' %>><%= cat %></option>
          <% }); %>
        </select>
      </div>
      <div>
        <label for="status">Status:</label>
        <select id="status" name="status">
          <option value="draft" <%= data.status === 'draft' ? 'selected' : '' %>>draft</option>
          <option value="publish" <%= data.status === 'publish' ? 'selected' : '' %>>publish</option>
        </select>
      </div>
      <div>
        <label>
          <input type="checkbox" name="allowComments" value="true" <%= data.allowComments ? 'checked' : '' %> /> Allow Comments
        </label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Body (Markdown)</legend>
      <div>
        <textarea id="body" name="body" rows="20" cols="100"><%= body %></textarea>
      </div>
      <div>
        <button type="submit">Save</button>
        <button type="button" onclick="preview()">Preview</button>
      </div>
    </fieldset>
  </form>
  <p><a href="/">‚Üê Back to list</a></p>

  <script>
    function preview() {
      const form = document.querySelector('form');
      const data = new FormData(form);
      fetch('/preview', { method: 'POST', body: new URLSearchParams(data) })
        .then(r => r.text())
        .then(html => {
          const w = window.open('', '_blank');
          w.document.open();
          w.document.write(html);
          w.document.close();
        })
        .catch(() => alert('Preview failed'));
    }
  </script>
</body>
</html>
